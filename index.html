

<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบค้นหาข้อมูลการขึ้นทะเบียนขอใช้รถ มหาวิทยาลัยวลัยลักษณ์</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Font - Sarabun -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Sarabun', sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .header {
      background-color: #004080;
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }
    .search-container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .result-container {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .nav-tabs {
      margin-bottom: 20px;
    }
    .tab-content {
      padding: 20px;
      background-color: #fff;
      border: 1px solid #dee2e6;
      border-top: none;
      border-radius: 0 0 10px 10px;
    }
    .image-container {
      margin-bottom: 20px;
      text-align: center;
    }
    .vehicle-image {
      max-width: 100%;
      height: auto;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      margin-top: 10px;
      max-height: 200px;
      object-fit: cover;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    .spinner-border {
      width: 3rem;
      height: 3rem;
    }
    .error-message {
      color: #dc3545;
      margin-top: 10px;
    }
    .success-message {
      color: #28a745;
      margin-top: 10px;
    }
    @media (max-width: 768px) {
      .header {
        padding: 15px;
      }
      .container {
        padding: 10px;
      }
    }
    /* เพิ่มสไตล์สำหรับแท็บ */
    .nav-link {
      color: #495057;
      font-weight: 500;
    }
    .nav-link.active {
      color: #004080;
      font-weight: 600;
    }
    /* สไตล์สำหรับปุ่ม */
    .btn-primary {
      background-color: #004080;
      border-color: #004080;
    }
    .btn-primary:hover {
      background-color: #003366;
      border-color: #003366;
    }
    /* สไตล์สำหรับการแสดงข้อมูล */
    .student-info {
      margin-bottom: 20px;
    }
    .student-info h3 {
      color: #004080;
      margin-bottom: 15px;
      border-bottom: 2px solid #004080;
      padding-bottom: 5px;
    }
    .student-info p {
      margin-bottom: 8px;
    }
    /* สไตล์สำหรับรูปภาพที่ไม่พบ */
    .image-not-found {
      background-color: #f8f9fa;
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      color: #6c757d;
    }
    /* สไตล์สำหรับการแสดงผลบนมือถือ */
    @media (max-width: 576px) {
      .vehicle-image {
        max-height: 150px;
      }
      .header h1 {
        font-size: 1.5rem;
      }
      .header h2 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-car"></i> ระบบค้นหาข้อมูลการขึ้นทะเบียนขอใช้รถ</h1>
      <h2>มหาวิทยาลัยวลัยลักษณ์</h2>
    </div>
    
    <div class="search-container">
      <h3>ค้นหาข้อมูล</h3>
      <div class="row">
        <div class="col-md-6 mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-id-card"></i></span>
            <input type="text" id="studentId" class="form-control" placeholder="กรอกรหัสนักศึกษา">
            <button class="btn btn-primary" onclick="searchStudent()">ค้นหา</button>
          </div>
        </div>
      </div>
      <div id="searchError" class="error-message"></div>
    </div>
    
    <div class="loading" id="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">กำลังโหลด...</span>
      </div>
      <p>กำลังค้นหาข้อมูล...</p>
    </div>
    
    <div class="result-container" id="resultContainer" style="display: none;">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">ข้อมูลทั่วไป</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images" type="button" role="tab" aria-controls="images" aria-selected="false">รูปภาพ</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button" role="tab" aria-controls="manage" aria-selected="false">จัดการข้อมูล</button>
        </li>
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
          <div id="studentInfo"></div>
        </div>
        <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
          <div id="vehicleImages"></div>
        </div>
        <div class="tab-pane fade" id="manage" role="tabpanel" aria-labelledby="manage-tab">
          <div id="manageData"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // URL ของ Web App
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbwXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec';
    
    // ตัวแปรสำหรับเก็บข้อมูลนักศึกษาและแถวในสเปรดชีต
    let currentStudentData = null;
    let currentRowIndex = null;
    
    // ฟังก์ชันสำหรับค้นหานักศึกษา
    function searchStudent() {
      // ดึงค่ารหัสนักศึกษา
      const studentId = document.getElementById('studentId').value.trim();
      
      // ตรวจสอบว่ามีการกรอกรหัสนักศึกษาหรือไม่
      if (!studentId) {
        document.getElementById('searchError').textContent = 'กรุณากรอกรหัสนักศึกษา';
        return;
      }
      
      // ล้างข้อความแสดงข้อผิดพลาด
      document.getElementById('searchError').textContent = '';
      
      // แสดงไอคอนโหลด
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultContainer').style.display = 'none';
      
      // สร้าง URL สำหรับการเรียก API
      const url = `${webAppUrl}?action=getStudentData&studentId=${encodeURIComponent(studentId)}`;
      
      // เรียกใช้ API
      fetch(url)
        .then(response => response.json())
        .then(data => {
          // ซ่อนไอคอนโหลด
          document.getElementById('loading').style.display = 'none';
          
          if (data.success) {
            // เก็บข้อมูลนักศึกษาและแถวในตัวแปร
            currentStudentData = data.data;
            currentRowIndex = data.rowIndex;
            
            // แสดงข้อมูลนักศึกษา
            displayStudentInfo(data.data);
            displayVehicleImages(data.data);
            displayManageData(data.data, data.rowIndex);
            
            // แสดงผลลัพธ์
            document.getElementById('resultContainer').style.display = 'block';
          } else {
            // แสดงข้อความแสดงข้อผิดพลาด
            document.getElementById('searchError').textContent = data.message || 'เกิดข้อผิดพลาดในการค้นหาข้อมูล';
          }
        })
        .catch(error => {
          // ซ่อนไอคอนโหลด
          document.getElementById('loading').style.display = 'none';
          
          // แสดงข้อความแสดงข้อผิดพลาด
          document.getElementById('searchError').textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message;
          console.error('Error:', error);
        });
    }
    
    // ฟังก์ชันสำหรับแสดงข้อมูลนักศึกษา
    function displayStudentInfo(data) {
      // สร้าง HTML สำหรับแสดงข้อมูล
      let html = `
        <div class="student-info">
          <h3>ข้อมูลนักศึกษา</h3>
          <div class="row">
            <div class="col-md-6">
              <p><strong>รหัสนักศึกษา:</strong> ${data.studentId}</p>
              <p><strong>ชื่อ-นามสกุล:</strong> ${data.fullName}</p>
              <p><strong>คณะ:</strong> ${data.faculty}</p>
              <p><strong>เบอร์โทรศัพท์:</strong> ${data.phoneNumber}</p>
              <p><strong>ที่พัก:</strong> ${data.residence}</p>
              <p><strong>รายละเอียดที่อยู่:</strong> ${data.addressDetail}</p>
            </div>
            <div class="col-md-6">
              <p><strong>ผู้ติดต่อฉุกเฉิน:</strong> ${data.emergencyContact}</p>
              <p><strong>ความสัมพันธ์:</strong> ${data.relationship}</p>
              <p><strong>เบอร์โทรฉุกเฉิน:</strong> ${data.emergencyPhone}</p>
              <p><strong>ประเภทยานพาหนะ:</strong> ${data.vehicleType}</p>
              <p><strong>ยี่ห้อ:</strong> ${data.brand}</p>
              <p><strong>ทะเบียนรถ:</strong> ${data.licensePlate} ${data.province}</p>
              <p><strong>สี:</strong> ${data.color}</p>
              <p><strong>หมายเลขสติกเกอร์:</strong> <span id="stickerNumber">${data.stickerNumber || 'ยังไม่ได้รับการจัดสรร'}</span></p>
            </div>
          </div>
        </div>
      `;
      
      // แสดงข้อมูลในพื้นที่ผลลัพธ์
      document.getElementById('studentInfo').innerHTML = html;
    }
    
    // ฟังก์ชันสำหรับแสดงรูปภาพยานพาหนะ
    function displayVehicleImages(data) {
      // สร้าง HTML สำหรับแสดงรูปภาพ
      let html = `
        <h3>รูปภาพยานพาหนะ</h3>
        <div class="row">
          <div class="col-md-3">
            <div class="image-container">
              <h5>ด้านหน้า</h5>
              ${createImageElement(data.frontImage, 'ด้านหน้า')}
            </div>
          </div>
          <div class="col-md-3">
            <div class="image-container">
              <h5>ด้านหลัง</h5>
              ${createImageElement(data.backImage, 'ด้านหลัง')}
            </div>
          </div>
          <div class="col-md-3">
            <div class="image-container">
              <h5>ด้านซ้าย</h5>
              ${createImageElement(data.leftImage, 'ด้านซ้าย')}
            </div>
          </div>
          <div class="col-md-3">
            <div class="image-container">
              <h5>ด้านขวา</h5>
              ${createImageElement(data.rightImage, 'ด้านขวา')}
            </div>
          </div>
        </div>
      `;
      
      // แสดงรูปภาพในพื้นที่ผลลัพธ์
      document.getElementById('vehicleImages').innerHTML = html;
    }
    
    // ฟังก์ชันสำหรับสร้าง element รูปภาพ
    function createImageElement(imageUrl, altText) {
      if (imageUrl && imageUrl.trim() !== '') {
        return `<img src="${imageUrl}" alt="${altText}" class="img-fluid vehicle-image" onerror="handleImageError(this, '${imageUrl}')">`;
      } else {
        return `<div class="image-not-found"><i class="fas fa-image fa-3x mb-2"></i><br>ไม่พบรูปภาพ</div>`;
      }
    }
    
    // ฟังก์ชันสำหรับจัดการเมื่อรูปภาพไม่สามารถโหลดได้
    function handleImageError(img, originalUrl) {
      console.log('ไม่สามารถโหลดรูปภาพ:', originalUrl);
      
      // ลองแปลง URL ถ้ายังไม่ได้แปลง
      if (!img.dataset.tried) {
        img.dataset.tried = 'true';
        
        // ถ้าเป็นลิงค์ lh3.googleusercontent.com ให้ใช้ลิงค์นั้นโดยตรง
        if (originalUrl.includes('lh3.googleusercontent.com')) {
          img.src = originalUrl;
          return;
        }
        
        // ถ้าเป็นลิงค์ Google Drive ให้ลองแปลง URL
        if (originalUrl.includes('drive.google.com')) {
          const fixedUrl = fixGoogleDriveUrl(originalUrl);
          if (fixedUrl !== originalUrl) {
            img.src = fixedUrl;
            return;
          }
        }
      }
      
      // ถ้าไม่สามารถโหลดได้หลังจากลองแปลง URL แล้ว ให้แสดงรูปภาพ placeholder
      img.onerror = null; // ป้องกันการเรียกซ้ำ
      img.src = 'https://via.placeholder.com/300x200?text=ไม่พบรูปภาพ';
    }
    
    // ฟังก์ชันสำหรับแก้ไข URL ของ Google Drive
    function fixGoogleDriveUrl(url) {
      if (!url) return '';
      
      // ถ้าเป็นลิงค์ lh3.googleusercontent.com ให้ใช้ลิงค์นั้นโดยตรง
      if (url.includes('lh3.googleusercontent.com')) {
        return url;
      }
      
      // ตรวจสอบว่าเป็น URL ของ Google Drive หรือไม่
      if (url.includes('drive.google.com')) {
        // ดึง file ID จาก URL
        let fileId = '';
        
        // กรณี URL รูปแบบ https://drive.google.com/file/d/FILE_ID/view
        if (url.includes('/file/d/')) {
          const match = url.match(/\/file\/d\/([^\/]+)/);
          if (match && match[1]) {
            fileId = match[1];
          }
        } 
        // กรณี URL รูปแบบ https://drive.google.com/open?id=FILE_ID
        else if (url.includes('open?id=')) {
          const match = url.match(/open\?id=([^&]+)/);
          if (match && match[1]) {
            fileId = match[1];
          }
        }
        // กรณี URL รูปแบบ https://drive.google.com/uc?export=view&id=FILE_ID
        else if (url.includes('uc?export=view&id=')) {
          const match = url.match(/id=([^&]+)/);
          if (match && match[1]) {
            fileId = match[1];
          }
        }
        // กรณีอื่นๆ ลองหา ID ที่มีรูปแบบเป็นตัวอักษรและตัวเลข 25-33 ตัว
        else {
          const match = url.match(/[-\w]{25,33}/);
          if (match) {
            fileId = match[0];
          }
        }
        
        // ถ้าพบ file ID ให้สร้าง URL ใหม่
        if (fileId) {
          // ลองใช้ URL ในรูปแบบ lh3.googleusercontent.com ก่อน
          return `https://lh3.googleusercontent.com/d/${fileId}`;
        }
      }
      
      // ถ้าไม่ใช่ URL ของ Google Drive หรือไม่สามารถแปลงได้ ให้ส่งคืน URL เดิม
      return url;
    }
    
    // ฟังก์ชันสำหรับแสดงข้อมูลการจัดการ
    function displayManageData(data, rowIndex) {
      // สร้าง HTML สำหรับแสดงข้อมูลการจัดการ
      let html = `
        <h3>จัดการข้อมูล</h3>
        <div class="form-group mb-3">
          <label for="newStickerNumber" class="form-label">หมายเลขสติกเกอร์:</label>
          <div class="input-group">
            <input type="text" class="form-control" id="newStickerNumber" value="${data.stickerNumber || ''}">
            <button class="btn btn-primary" onclick="updateStickerNumber(${rowIndex})">บันทึก</button>
          </div>
          <div id="updateStickerResult" class="mt-2"></div>
        </div>
      `;
      
      // แสดงข้อมูลในพื้นที่ผลลัพธ์
      document.getElementById('manageData').innerHTML = html;
    }
    
    // ฟังก์ชันสำหรับอัปเดตหมายเลขสติกเกอร์
    function updateStickerNumber(rowIndex) {
      // ดึงค่าหมายเลขสติกเกอร์ใหม่
      const newStickerNumber = document.getElementById('newStickerNumber').value.trim();
      
      // แสดงไอคอนโหลด
      document.getElementById('updateStickerResult').innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">กำลังบันทึก...</span></div> กำลังบันทึกข้อมูล...';
      
      // สร้างข้อมูลสำหรับส่งไปยัง API
      const formData = new FormData();
      formData.append('action', 'updateStickerNumber');
      formData.append('rowIndex', rowIndex);
      formData.append('stickerNumber', newStickerNumber);
      
      // เรียกใช้ API
      fetch(webAppUrl, {
        method: 'POST',
        body: formData
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // อัปเดตข้อมูลในหน้าเว็บ
            document.getElementById('stickerNumber').textContent = newStickerNumber || 'ยังไม่ได้รับการจัดสรร';
            document.getElementById('updateStickerResult').innerHTML = '<div class="success-message"><i class="fas fa-check-circle"></i> บันทึกข้อมูลสำเร็จ</div>';
            
            // อัปเดตข้อมูลในตัวแปร
            if (currentStudentData) {
              currentStudentData.stickerNumber = newStickerNumber;
            }
          } else {
            // แสดงข้อความแสดงข้อผิดพลาด
            document.getElementById('updateStickerResult').innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${data.error || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล'}</div>`;
          }
        })
        .catch(error => {
          // แสดงข้อความแสดงข้อผิดพลาด
          document.getElementById('updateStickerResult').innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> เกิดข้อผิดพลาดในการเชื่อมต่อ: ${error.message}</div>`;
          console.error('Error:', error);
        });
    }
    
    // เพิ่ม event listener สำหรับการกด Enter ในช่องค้นหา
    document.getElementById('studentId').addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchStudent();
      }
    });
    
    // ทดสอบการเชื่อมต่อกับ API เมื่อโหลดหน้าเว็บ
    window.addEventListener('load', function() {
      fetch(`${webAppUrl}?action=testConnection`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('การเชื่อมต่อกับ API ทำงานได้:', data.timestamp);
          } else {
            console.error('การเชื่อมต่อกับ API ล้มเหลว');
          }
        })
        .catch(error => {
          console.error('เกิดข้อผิดพลาดในการเชื่อมต่อกับ API:', error);
        });
    });
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'94d2b00624d07336',t:'MTc0OTQ5MzY5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
